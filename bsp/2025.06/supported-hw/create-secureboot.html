<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creating SecureBoot Images :: Microchip UNG BSP Documentation</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">Microchip UNG BSP Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="bsp" data-version="2025.06">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">BSP Releases</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">ReadMe</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../release-notes/nav.html">Release Notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../bootloader.html">Bootloader</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Supported HW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lan966x.html">LAN966x</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-boot.html">Booting</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-tfa.html">SecureBoot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-tfa_ctl.html">TFA_CTL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-overlays.html">Overlays</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-flexcom.html">FLEXCOM</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-usart.html">USART</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-spi.html">SPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-i2c.html">I2C</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-qspi.html">QSPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-mmc.html">MMC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-pinctrl.html">GPIO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-mcan.html">MCAN</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-wdt.html">Watchdog Timer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-aes-sha.html">Crypto HW Accelerators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-otp.html">OTP Configuration from Linux userspace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-udphs.html">UDPHS - USB Device</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="sparx5.html">Sparx5</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="sparx5-boot.html">Booting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lan969x.html">LAN969x</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-boot.html">Booting</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-tfa.html">SecureBoot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-verified-boot.html">Verified Boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-flexcom.html">FLEXCOM</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-usart.html">USART</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-spi.html">SPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-i2c.html">I2C</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-qspi.html">QSPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-mmc.html">MMC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-pinctrl.html">GPIO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-sgpio.html">SGPIO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-mcan.html">MCAN</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-wdt.html">Watchdog Timer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-otp.html">OTP Configuration from Linux userspace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-usb.html">USB Host Device</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="create-secureboot.html">Creating SecureBoot Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="restore-secureboot.html">Restoring SecureBoot Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pcie-rpi4cm.html">PCIe Endpoint with RPI CM4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lan966x-spi-host.html">LAN9662 as a SPI host</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../network_overview.html">Network</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tools_overview.html">Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../front_ports.html">Front Ports</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tuning_performance.html">Tuning Network Performance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">L2 Bridge</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../bridge_configuration.html">Bridge Configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Frame Forwarding</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../forwarding_overview.html">Forwarding Overview</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../frame_meta_data.html">Frame Metadata</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tc/tc-intro.html">TC Introduction</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tc/tc-flower-vcap.html">TC and VCAP</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../vcap_tool.html">VCAP tool</a>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ingress</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../basic_qos.html">Basic QoS</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-is1.html">Classification (IS0/IS1)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-is2.html">ACL (IS2)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../policing.html">Policing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Egress</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../scheduling.html">Scheduling</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../frame_preemption.html">Frame Preemption</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../shaping.html">Shaping</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-es2.html">Egress ACL (ES2)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-etag.html">Basic VLAN tagging</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-es0.html">Rewriter VLAN tagging (ES0)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../psfp.html">PSFP</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../frer.html">FRER</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../l3_unicast_routing.html">L3 Unicast Routing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Protection switching</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../mrp.html">MRP</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cfm.html">CFM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ptp.html">PTP</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../redbox.html">HSR/PRP</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../xdp.html">eXpress Data Path (XDP)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">BSP Releases</span>
    <span class="version">2025.06</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">BSP Releases</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">2025.06</a>
        </li>
        <li class="version">
          <a href="../../2025.06-1/index.html">2025.06-1</a>
        </li>
        <li class="version">
          <a href="../../2025.03/index.html">2025.03</a>
        </li>
        <li class="version">
          <a href="../../2024.12/index.html">2024.12</a>
        </li>
        <li class="version">
          <a href="../../2024.09/index.html">2024.09</a>
        </li>
        <li class="version">
          <a href="../../2024.06/index.html">2024.06</a>
        </li>
        <li class="version">
          <a href="../../2024.03/index.html">2024.03</a>
        </li>
        <li class="version">
          <a href="../../2024.03-1/index.html">2024.03-1</a>
        </li>
        <li class="version">
          <a href="../../2023.12/index.html">2023.12</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="#">Older (on AWS)</a>
      <ul class="versions">
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.09-1.html">2023.09-1</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.09.html">2023.09</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.06.html">2023.06</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.03.html">2023.03</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.12.html">2022.12</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.09.html">2022.09</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.06.html">2022.06</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.03.html">2022.03</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2021.12.html">2021.12</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2021.09.html">2021.09</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">BSP Releases</a></li>
    <li>Supported HW</li>
    <li><a href="create-secureboot.html">Creating SecureBoot Images</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">2025.06</button>
  <div class="version-menu">
    <a class="version is-current" href="create-secureboot.html">2025.06</a>
    <a class="version" href="../../2025.06-1/supported-hw/create-secureboot.html">2025.06-1</a>
    <a class="version is-missing" href="../../2025.03/index.html">2025.03</a>
    <a class="version is-missing" href="../../2024.12/index.html">2024.12</a>
    <a class="version is-missing" href="../../2024.09/index.html">2024.09</a>
    <a class="version is-missing" href="../../2024.06/index.html">2024.06</a>
    <a class="version is-missing" href="../../2024.03/index.html">2024.03</a>
    <a class="version is-missing" href="../../2024.03-1/index.html">2024.03-1</a>
    <a class="version is-missing" href="../../2023.12/index.html">2023.12</a>
  </div>
</div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Creating SecureBoot Images</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>To understand how secure boot works in Microchip Ethernet SoCs you should start
by reading the TF-A section for the platform you want to use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="lan966x-tfa.html" class="xref page">LAN966x TF-A</a></p>
</li>
<li>
<p><a href="lan969x-tfa.html" class="xref page">LAN969x TF-A</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the current section we will show you how to setup a secure boot system from
scratch using your own keys.</p>
</div>
<div class="paragraph">
<p>The steps we will cover are these:</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p>Use the TF-A project to create your own keys and the images that
uses these keys.</p>
</li>
<li>
<p>Adding the key material and images to the system</p>
</li>
<li>
<p>Booting the system using the new software and keys</p>
</li>
<li>
<p>Updating the system with new software</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The following description shows how to perform the steps for LAN969x and
use the most advanced solution.  You can customize this procedure to your own
needs, but be aware that items that gets programmed into the OTP of the system
cannot be undone or erased.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_lan969x_images"><a class="anchor" href="#_creating_lan969x_images"></a>1. Creating LAN969x images</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the following we will create authenticated and encrypted versions of these
images:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BL2 (Trusted Boot Firmware)</p>
</li>
<li>
<p>BL31 (EL3 Runtime Software)</p>
</li>
<li>
<p>BL33 (Non-trusted Firmware, aka U-Boot in this description)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This will be done with a set of new keys.</p>
</div>
<div class="paragraph">
<p>The procedures for getting and building the TF-A project are described here:</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p><a href="lan969x-tfa.html#build_env" class="xref page">Build Environment (Docker Run)</a></p>
</li>
<li>
<p><a href="lan969x-tfa.html#getting_tfa" class="xref page">Getting sources and releases</a></p>
</li>
<li>
<p><a href="lan969x-tfa.html#building_tfa" class="xref page">Building</a></p>
</li>
<li>
<p><a href="lan969x-tfa.html#tfa_keys" class="xref page">Authentication Keys</a></p>
</li>
<li>
<p><a href="lan969x-tfa.html#tfa_image_encryption" class="xref page">Image Encryption</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We will be using the SSK to encrypt the images for delivery to the system, but
on the system we will then re-encrypt (bind) the images to the specific system
with a HUK.</p>
</div>
<div class="paragraph">
<p>The TF-A build script will include a default U-Boot version, but in the
following we fetch and use the latest version available.</p>
</div>
<div class="paragraph">
<p>So this is what we do:</p>
</div>
<div class="paragraph">
<p>Clone the project:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/microchip-ung/arm-trusted-firmware</pre>
</div>
</div>
<div class="paragraph">
<p>Remove the demo keys:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>rm keys/*</pre>
</div>
</div>
<div class="paragraph">
<p>Build a new set of keys for LAN969x:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dr ./scripts/build.rb -p lan969x_a0 --create_keys --release</pre>
</div>
</div>
<div class="paragraph">
<p>Get the latest version of U-Boot for LAN969x:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wget http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mchp-brsdk-arm64-2025.03.tar.gz
tar xf mchp-brsdk-arm64-2025.03.tar.gz --wildcards */u-boot-mchp_lan969x.bin --strip-components=4</pre>
</div>
</div>
<div class="paragraph">
<p>Build the images (and the latest U-Boot) and encrypt these with the new SSK:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dr ./scripts/build.rb -p lan969x_a0 --release \
    --bl33_blob u-boot-mchp_lan969x.bin \
    --encrypt-images BL2,BL31,BL33 --encrypt-ssk ./keys/ssk.bin</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
During the build you will see warnings that relates to the GPT such as
this: <code>Caution: Found protective or hybrid MBR and corrupt GPT</code>. This is not
an error in the build, but is caused by a truncation of the disk image, which
removes the backup table to save space.  The backup table will automatically be
recreated when the filesystem is used.  These warnings can therefore be ignored.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we have these results:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new set of keys in <code>./keys</code></p>
</li>
<li>
<p>A new set of images in <code>./build/lan969x_a0/release</code></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure that you keep your keys in a secure storage from now on.
See <a href="lan969x-tfa.html#guideline" class="xref page">Guideline for for secure
provisioning</a> for more information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the following we will need to use these keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ROT Public Key SHA256 value: <code>keys/rotpk_ecdsa_sha256.bin</code></p>
</li>
<li>
<p>SSK value: <code>keys/ssk.bin</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_creating_a_key_file"><a class="anchor" href="#_creating_a_key_file"></a>1.1. Creating a key file</h3>
<div class="paragraph">
<p>To make it easy to transfer and program the keys in your system, you can create
a binary file that contains these two keys and has room for two more.  The content
of the file must be like this:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 33.3335%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Offset</th>
<th class="tableblock halign-center valign-top">Size in bytes</th>
<th class="tableblock halign-center valign-top">OTP Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ROTPK SHA256</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The SHA256 of the ROT Public Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">keys/rotpk_ecdsa_sha256.bin</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x20</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">HUK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Hardware Unique Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Leave at 0</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x40</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">EK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The endorsement key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Leave at 0</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x60</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">SSK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Secret Symmetric Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">keys/ssk.bin</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The EK (endorsement key) is not used in this version of TF-A.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is how you can create the file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>cp keys/rotpk_ecdsa_sha256.bin lan969x_keys.bin
truncate -s 96 lan969x_keys.bin
cat keys/ssk.bin &gt;&gt; lan969x_keys.bin</pre>
</div>
</div>
<div class="paragraph">
<p>The lan969x_keys.bin file can then be transferred to the system (e.g. via a
network connection or a USB stick) and used to program the keys in one operation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_keys_and_images_to_the_system"><a class="anchor" href="#_adding_keys_and_images_to_the_system"></a>2. Adding keys and images to the system</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You should have a LAN969x system that boots without secure boot as a
prerequisite.</p>
</div>
<div class="paragraph">
<p>Start by booting this system into the Linux Console.</p>
</div>
<div class="sect2">
<h3 id="_using_the_otp_tool"><a class="anchor" href="#_using_the_otp_tool"></a>2.1. Using the OTP tool</h3>
<div class="paragraph">
<p>In the following we will program and protect the keys on the system.  This done
using the <code>otp</code> tool in the root file system.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure you understand how the tool works before making any changes
to your system, as the changes cannot be reversed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is where the tool is described: <a href="lan969x-otp.html" class="xref page">LAN969X
OTP Configuration from Linux userspace</a></p>
</div>
<div class="paragraph">
<p>The system keys are stored in region 4 of the OTP and consists of these 5
keys:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Offset</th>
<th class="tableblock halign-left valign-top">Size in bytes</th>
<th class="tableblock halign-center valign-top">OTP Field</th>
<th class="tableblock halign-center valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x0100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">OTP_TBBR_ROTPK</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The SHA256 of the ROT Public Key</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x0120</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">OTP_TBBR_HUK</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The Hardware Unique Key</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x0140</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">OTP_TBBR_EK</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The endorsement key</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x0160</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">OTP_TBBR_SSK</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The Secret Symmetric Key</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0x0180</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">OTP_SJTAG_SSK</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The SSK for the JTAG interface</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Now use the OTP tool to display the OTP fields:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field list</pre>
</div>
</div>
<div class="paragraph">
<p>As long as the system has not been locked down (the keys have been protected)
then you can read the fields containing the keys.</p>
</div>
<div class="paragraph">
<p>Here is how to read the ROT SHA256 field, the HUK field, the EK field and the
SSK field:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_ROTPK
otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_HUK
otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_EK
otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_SSK</pre>
</div>
</div>
<div class="paragraph">
<p>This group of 4 keys are the ones that the otp tools <code>import-keys</code> command can
program in one operation,</p>
</div>
<div class="paragraph">
<p>For now all these fields should contain all zeroes.</p>
</div>
<div class="paragraph">
<p>Now transfer the lan969x_keys.bin file to your system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Put the lan969x_keys.bin file /tmp folder on your LAN969x&#8217;s file system as
this folder is always writable.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now program your system with these keys and create a HUK on the fly with
the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem import-keys /tmp/lan969x_keys.bin</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The HUK will be generated on the fly by the OTP program which will ensure
that it never leaves the system.  If you do not want to use a HUK you must add
the <code>--no-randomize-huk</code> option to the <code>otp</code> tool command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The result of the command can be inspected by reading the 4 keys with the otp
tool again:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_ROTPK
otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_HUK
otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_EK
otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_SSK</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The OTP_TBBR_ROTPK should have the same value as in the original
<code>keys/rotpk_ecdsa_sha256.bin</code> file.</p>
</li>
<li>
<p>The OTP_TBBR_HUK field should contain a random value.</p>
</li>
<li>
<p>The OTP_TBBR_EK field should still contain all zeroes.</p>
</li>
<li>
<p>The OTP_TBBR_SSK field should contain same value as in the original
<code>keys/ssk.bin</code> file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can compare the binary contents of the files using the <code>hexdump</code> tool with
the <code>-C</code> option.</p>
</div>
</div>
<div class="sect2">
<h3 id="_secure_jtag_key"><a class="anchor" href="#_secure_jtag_key"></a>2.2. Secure JTAG key</h3>
<div class="paragraph">
<p>The OTP_SJTAG_SSK field is also part of the OTP key region, so before you
protect the region you will need to decide if this field should have a non-zero
value.</p>
</div>
<div class="paragraph">
<p>If you want to project access to your system via JTAG you should put a random
number value in this location.  This can be done like this.</p>
</div>
<div class="paragraph">
<p>Generate a random 32 byte value:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>head -c 32 /dev/urandom | xxd -p -c 32</pre>
</div>
</div>
<div class="paragraph">
<p>Write this value to the OTP_SJTAG_SSK field in the OTP:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field set OTP_SJTAG_SSK \
    hex &lt;the output from the xxd command above&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Remember to save the key value in a safe place in case you later need to use the
Secure JTAG.</p>
</div>
</div>
<div class="sect2">
<h3 id="_protect_access_to_keys_in_your_system"><a class="anchor" href="#_protect_access_to_keys_in_your_system"></a>2.3. Protect access to keys in your system</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Only take the next step if you are done with programming the keys.
In particular you need to consider if you need to protect the JTAG interface
with an SSK like shown in the previous section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you should prevent your keys from being changed any further.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>otp -d  /sys/bus/nvmem/devices/lan9662-otp0/nvmem region write-protect 4</pre>
</div>
</div>
<div class="paragraph">
<p>This protects region 4 (the key region) from being written to, and also from
being accessed from the Non-secure world (e.g Linux).</p>
</div>
<div class="paragraph">
<p>This protection will take effect after the next reboot.</p>
</div>
<div class="paragraph">
<p>After rebooting the system it is no longer possible to read out the keys with
the OTP tool.</p>
</div>
<div class="paragraph">
<p>If you try to use the OTP tool to get the SSK you now will just see all-zeroes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># otp -d /sys/bus/nvmem/devices/lan9662-otp0/nvmem field get OTP_TBBR_SSK
32 0000000000000000000000000000000000000000000000000000000000000000|................................|</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_booting_the_system_using_the_new_software_and_keys"><a class="anchor" href="#_booting_the_system_using_the_new_software_and_keys"></a>3. Booting the system using the new software and keys</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have been updating the ROT, the SSK and the HUK on your system in the
previous section, so the current images stored in NOR flash (or eMMC) will no
longer be able to boot as they do not contain the expected certificates.</p>
</div>
<div class="paragraph">
<p>So you must now update the NOR flash storage with the nor.gpt image containing
the signed and encrypted images found here: <code>build/lan969x_a0/release/nor.gpt</code>
(or <code>build/lan969x_a0/release/mmc.gpt</code> for the eMMC storage).</p>
</div>
<div class="paragraph">
<p>This GPT image has the FIP that contains the BL2, BL31 and BL33 signed with the
correct keys, but these 3 images need to be re-encrypted with the BSSK (which is a
key derived from the HUK stored in the device) before being stored in flash.</p>
</div>
<div class="paragraph">
<p>Use the <a href="restore-secureboot.html#fwu" class="xref page">FWU</a> section to start a
browser and load the HTML file found here: <code>build/lan969x_a0/release/fwu.html</code>.
This has the BL2U image embedded which can then be downloaded to the system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You must use the fwu.html file from the build you did earlier, as the
embedded BL2U image is also encrypted with SSK that has been programmed into the
OTP of your system.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the correct BL2U image has been loaded and is running in your system select
the "Incremental" tab in the FWU interface and use the "Choose File" button to
upload the <code>nor.gpt</code> file from your build folder.</p>
</div>
<div class="paragraph">
<p>Select which destination you want for the image by selecting
either <code>NOR flash</code> or <code>eMMC</code> in for the incremental write operation.</p>
</div>
<div class="paragraph">
<p>Press the "Incremental Write Image" button to start the transfer.  This will
take some time so please be patient.  The download may start several times and
write each chunk to the flash before continuing.</p>
</div>
<div class="paragraph">
<p>Finally you need to use the "Bind FIP in Flash" button: This will decrypt the
boot stage images contained in the flash using the SSK and re-encrypt them using
a key derived from the HUK in your system (the BSSK) and write them back in
place.</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="../_images/bl2u_ssk_bind.png" alt="bind" width="600">
</div>
</div>
<div class="paragraph">
<p>You should now be able to boot your system using the GTP image in your NOR or
eMMC Flash.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are not using BSSK encryption (the HUK), then you just need to skip
the "Bind FIP in Flash" step.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_the_system_with_new_software"><a class="anchor" href="#_updating_the_system_with_new_software"></a>4. Updating the system with new software</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In case you need to update the software on your secure booting system, you need
to make sure that you build the images using the same set of keys as you did
when you did your first secure boot.</p>
</div>
<div class="paragraph">
<p>So fetch the set of keys from your secure offline storage and put them in your
projects <code>keys</code> folder and prepare to build new images.</p>
</div>
<div class="paragraph">
<p>If you need to prevent rollback to earlier versions of the software you can
increment the secure and/or non-secure counters in your certificates.  This is
described in more details in the
<a href="lan969x-tfa.html#nvcounters" class="xref page">Rollback protection</a> section.</p>
</div>
<div class="paragraph">
<p>This will update your systems counters, so it will no longer be possible to boot
images that contain counters with lower values.</p>
</div>
<div class="paragraph">
<p>To build your system with a Trusted FW NV counter of 4 and a Non-Trusted FW NV
counter of 3 you need to build the software like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dr ./scripts/build.rb -p lan969x_a0 --release --fw-nvctr 4 --ntfw-nvctr 3 \
    --bl33_blob u-boot-mchp_lan969x.bin \
    --encrypt-images BL2,BL31,BL33 --encrypt-ssk ./keys/ssk.bin</pre>
</div>
</div>
<div class="paragraph">
<p>You then follow the description in the previous section to connect, upload and
bind the new GPT image to your system.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  This page was built using <a href="https://antora.org">Antora</a>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
