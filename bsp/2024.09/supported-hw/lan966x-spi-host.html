<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EVB-LAN9662 as a SPI Host :: Microchip UNG BSP Documentation</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">Microchip UNG BSP Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="bsp" data-version="2024.09">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">BSP Releases</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">ReadMe</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../release-notes/nav.html">Release Notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../bootloader.html">Bootloader</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Supported HW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lan966x.html">LAN966x</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-boot.html">Booting</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-tfa.html">SecureBoot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-tfa_ctl.html">TFA_CTL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-overlays.html">Overlays</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-flexcom.html">FLEXCOM</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-usart.html">USART</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-spi.html">SPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-i2c.html">I2C</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-qspi.html">QSPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-mmc.html">MMC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-pinctrl.html">GPIO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-mcan.html">MCAN</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-wdt.html">Watchdog Timer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-aes-sha.html">Crypto HW Accelerators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-otp.html">OTP Configuration from Linux userspace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan966x-udphs.html">UDPHS - USB Device</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sparx5.html">Sparx5</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lan969x.html">LAN969x</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-boot.html">Booting</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-tfa.html">SecureBoot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-verified-boot.html">Verified Boot</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-flexcom.html">FLEXCOM</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-usart.html">USART</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-spi.html">SPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-i2c.html">I2C</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-qspi.html">QSPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-mmc.html">MMC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-pinctrl.html">GPIO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-sgpio.html">SGPIO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-mcan.html">MCAN</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-wdt.html">Watchdog Timer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-otp.html">OTP Configuration from Linux userspace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lan969x-usb.html">USB Host Device</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="restore-secureboot.html">Restoring SecureBoot Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pcie-rpi4cm.html">PCIe Endpoint with RPI CM4</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="lan966x-spi-host.html">LAN9662 as a SPI host</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Network</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../network_overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tools_overview.html">Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../front_ports.html">Front Ports</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tuning_performance.html">Tuning Network Performance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">L2 Bridge</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../bridge_configuration.html">Bridge Configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Frame Forwarding</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../forwarding_overview.html">Forwarding Overview</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../frame_meta_data.html">Frame Metadata</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tc/tc-intro.html">TC Introduction</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tc/tc-flower-vcap.html">TC and VCAP</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../vcap_tool.html">VCAP tool</a>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ingress</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../basic_qos.html">Basic QoS</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-is1.html">Classification (IS0/IS1)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-is2.html">ACL (IS2)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../policing.html">Policing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Egress</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../scheduling.html">Scheduling</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../frame_preemption.html">Frame Preemption</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../shaping.html">Shaping</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-es2.html">Egress ACL (ES2)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-etag.html">Basic VLAN tagging</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tc/tc-es0.html">Rewriter VLAN tagging (ES0)</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../psfp.html">PSFP</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../frer.html">FRER</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../l3_unicast_routing.html">L3 Unicast Routing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Protection switching</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../mrp.html">MRP</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cfm.html">CFM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ptp.html">PTP</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">BSP Releases</span>
    <span class="version">2024.09</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">BSP Releases</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">2024.09</a>
        </li>
        <li class="version">
          <a href="../../2024.06/index.html">2024.06</a>
        </li>
        <li class="version">
          <a href="../../2024.03/index.html">2024.03</a>
        </li>
        <li class="version">
          <a href="../../2024.03-1/index.html">2024.03-1</a>
        </li>
        <li class="version">
          <a href="../../2023.12/index.html">2023.12</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="#">Older (on AWS)</a>
      <ul class="versions">
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.09-1.html">2023.09-1</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.09.html">2023.09</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.06.html">2023.06</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2023.03.html">2023.03</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.12.html">2022.12</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.09.html">2022.09</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.06.html">2022.06</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2022.03.html">2022.03</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2021.12.html">2021.12</a>
        </li>
        <li class="version">
          <a href="http://mscc-ent-open-source.s3-eu-west-1.amazonaws.com/public_root/bsp/mscc-brsdk-doc-2021.09.html">2021.09</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">BSP Releases</a></li>
    <li>Supported HW</li>
    <li><a href="lan966x-spi-host.html">LAN9662 as a SPI host</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">2024.09</button>
  <div class="version-menu">
    <a class="version is-current" href="lan966x-spi-host.html">2024.09</a>
    <a class="version is-missing" href="../../2024.06/index.html">2024.06</a>
    <a class="version is-missing" href="../../2024.03/index.html">2024.03</a>
    <a class="version is-missing" href="../../2024.03-1/index.html">2024.03-1</a>
    <a class="version is-missing" href="../../2023.12/index.html">2023.12</a>
  </div>
</div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">EVB-LAN9662 as a SPI Host</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This describes how to use one EVB-LAN9662 to control another EVB-LAN9662 using a SPI interface.</p>
</div>
<div class="paragraph">
<p>The method can be extended to control other Microchip Ethernet switch SoCs, but here we focus on the simple setup using
two identical devices for demonstration purposes.</p>
</div>
<div class="paragraph">
<p>The SPI interface control is enabled in a LAN966x SoC when booting in strap mode 15.</p>
</div>
<div class="paragraph">
<p>In this mode the host has access to all registers in the CSR ring.  These are the registers in the VML model
that are not labelled with an instance name.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-center valign-top">Type</th>
<th class="tableblock halign-left valign-top">VML Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEVCPU_GCB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">CSR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://microchip-ung.github.io/lan9662_reginfo/reginfo_LAN9662.html?select=devcpu_gcb" class="bare">https://microchip-ung.github.io/lan9662_reginfo/reginfo_LAN9662.html?select=devcpu_gcb</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PCIE_CFG</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">amba_axi_top</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://microchip-ung.github.io/lan9662_reginfo/reginfo_LAN9662.html?select=pcie_cfg" class="bare">https://microchip-ung.github.io/lan9662_reginfo/reginfo_LAN9662.html?select=pcie_cfg</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In the examples above the SPI host can access the registers in DEVCPU_GCB directly but not the registers in PCIE_CFG.</p>
</div>
<div class="sect2">
<h3 id="_access_to_other_register_groups_than_csr"><a class="anchor" href="#_access_to_other_register_groups_than_csr"></a>Access to other register groups than CSR</h3>
<div class="paragraph">
<p>In Microchip Ethernet Switches other register groups than the CSR group can be accessed indirectly via
<a href="http://vmlinfo.microsemi.net/vmlinfo.html?file=cml_files/maserati/ENT_maserati_m31668_RegInfo_2022-05-20/maserati_ALL.cml&amp;select=devcpu_gcb,vcore_access">VCORE Access</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_host_configuration"><a class="anchor" href="#_host_configuration"></a>Host Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use the SPI connection from Linux userspace the Linux Kernel must provide a SPI character device that can send and
receive data via a SPI controller in the host.</p>
</div>
<div class="paragraph">
<p>This requires that the Kernel configuration is changed and that a Device Tree node is added with a
configuration for the SPI host controller and a sub node that has a SPI device.</p>
</div>
<div class="paragraph">
<p>This configuration is available for use with the current BSP release, but it must be enabled before it can be used.</p>
</div>
<div class="paragraph">
<p>This is done with a device tree overlay that adds the Flexcom2 SPI device to the default devicetree for the EVB.
See <a href="lan966x-overlays.html" class="xref page">LAN966x Overlays</a> for more information.</p>
</div>
<div class="paragraph">
<p>To enable the SPI device the pcb variable in U-Boot must be set to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pcb=lan9662_ung8291_0_at_lan966x#lan966x_pcb8291_fc2_spi_0_at_lan966x</pre>
</div>
</div>
<div class="paragraph">
<p>to load both the main device tree and the overlay that provides the spi device configuration.</p>
</div>
<div class="paragraph">
<p>The source of the device tree overlay can be seen here: <a href="#appendix_a">spidev2 overlay</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_client_configuration"><a class="anchor" href="#_client_configuration"></a>Client Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The client EVB must be configured to boot into SPI device mode.  This is done by setting the VCORE boot straps to 15.
See <a href="lan966x-boot.html#pin_modes" class="xref page">Strapping PIN modes</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_spi_devices"><a class="anchor" href="#_connecting_spi_devices"></a>Connecting SPI devices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The two EVB-LAN9662 devices must be connected such that the host uses the Flexcom2 spi pins on its J2 extension
connector and the client uses the QSPI device on its J2 extension connector.</p>
</div>
<div class="paragraph">
<p>Here is a wiring table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SPI Signal Name</th>
<th class="tableblock halign-center valign-top">EVB-LAN9662 Host</th>
<th class="tableblock halign-center valign-top">EVB-LAN9662 Client</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chip Select</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_51 (GPIO51)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_36 (SPI.nCS)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clock</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_43 (FC2b_SCLK)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_40 (SPI.SCK)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MOSI</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_45 (FC2b_MOSI)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_35 (SPI.D1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISO</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_44 (FC2b_MISO)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_38 (SPI.D0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ground</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_39</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">J2_39</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And here is the pins on the J2 extension header:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/evb-lan9662-extension-pinheader.png" alt="evb-lan9662-extension-pinheader" width="600">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spi_read_and_write_format"><a class="anchor" href="#_spi_read_and_write_format"></a>SPI read and write format</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Microchip Switch SoC uses a simple read and write format for the SPI transactions.</p>
</div>
<div class="paragraph">
<p>The format uses a 3 byte payload</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1 bit for read/write operation where 1 means write</p>
</li>
<li>
<p>23 bits for the address path</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The address to be used is found in the VML model, but as VML uses words (32 bit) as the address unit you need to do a 2
bit shift when using this address and a mask to avoid changing the R/W bit.</p>
</div>
<div class="paragraph">
<p>For write operations this is followed by a 4 byte register value.</p>
</div>
<div class="paragraph">
<p>The endianness is always bigendian for the address part, but controlled by the if_ctrl endianness bit for the data part
(the 32bit register value).</p>
</div>
<div class="paragraph">
<p>If the speed is sufficiently high you will need one padding byte for the read operation (above approx. 800KHz) between
sending the address and sending 0xff bytes to receive the response.</p>
</div>
<div class="paragraph">
<p>Here is an example of reading the Chip ID:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/lan9662-spi-read-chipid.png" alt="lan9662 spi read chipid">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_tool_use"><a class="anchor" href="#_test_tool_use"></a>Test tool use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The BSP root file system for the EVB-LAN966x includes a test tool that can read and write a register.</p>
</div>
<div class="paragraph">
<p>This tool is included only for demonstration purposes, but can be very useful when bringing up a SPI connection.</p>
</div>
<div class="paragraph">
<p>The tool is called <code>spi-reg</code> and this the help information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    # spi_reg -h
    Usage: spi_reg spi_dev word_address_hex [new_value_hex]
    Options:
            -h | --help                     Show this help text
            -p | --padding BYTES            Use this number of padding bytes.  Default is 1
            -f | --frequency FREQ_HZ        Clock frequency to use in Hz.  Default is 1MHz

    Examples:
            Reading a value from word address 0x1000:
                    spi_reg /dev/spidev1.0 0x1000

            Writing 0xdeadbeef to word address 0x1002:
                    spi_reg /dev/spidev1.0 0x1002 0xdeadbeef</pre>
</div>
</div>
<div class="paragraph">
<p>Now you need to find the name of your spi device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    # ls -l /dev/spi*
    crw-------    1 root     root      153,   0 Jan  1 00:00 /dev/spidev2.0</pre>
</div>
</div>
<div class="paragraph">
<p>Next read the work at work register address 0x1000:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    # spi_reg /dev/spidev2.0 0x1000
    DEV: /dev/spidev2.0, Freq: 1000000, Padding: 1
    RX: 00 10 00-19 66 04 45</pre>
</div>
</div>
<div class="paragraph">
<p>Reading the 32-bit word at address 0x1000 returns the value <code>0x19660445</code>.</p>
</div>
<div class="paragraph">
<p>The default settings: padding = 1 (one byte extra is sent to the device to allow it time to respond) and frequency =
1000000 is used to perform the operation.  Normally you do not need to change the default values.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The padding byte is not shown when the data is displayed in the console.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please note that the padding is only used when reading and must match the response time that the target device has
otherwise the read result will not be correct.</p>
</div>
<div class="paragraph">
<p>Writing a value of 0x1234abcd to the address 0x1002 can be done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    # spi_reg /dev/spidev2.0 0x1002 0x1234abcd
    DEV: /dev/spidev2.0, Freq: 1000000, Padding: 1
    Write value: 0x1234abcd
    TX: 80 10 02-12 34 ab cd -&gt; OK
    RX: 00 10 02-12 34 ab cd</pre>
</div>
</div>
<div class="paragraph">
<p>Here the tool reads back the updated value and compares it with the value provided on the command line.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendices"><a class="anchor" href="#_appendices"></a>Appendices</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="appendix_a"><a class="anchor" href="#appendix_a"></a>Appendix A: Device Tree Overlay</h3>
<div class="paragraph">
<p>This is what the device tree for EVB-LAN9662 looks like when enable Flexcom2&#8217;s spi interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/dts-v1/;
/plugin/;

#include &lt;atmel-flexcom.h&gt;
#include &lt;gpio.h&gt;

/ {
	fragment@0 {
		target = &lt;&amp;flx2&gt;;
		__overlay__ {
		    atmel,flexcom-mode = &lt;ATMEL_FLEXCOM_MODE_SPI&gt;;
		    status = "okay";

		    spi2: spi@400 {
			pinctrl-0 = &lt;&amp;fc2_spi_pins&gt;;
			pinctrl-names = "default";
			cs-gpios = &lt;&amp;gpio 51 GPIO_ACTIVE_LOW&gt;;
			status = "okay";

			spi@0 {
			    compatible = "spidev";
			    reg = &lt;0&gt;;
			    spi-max-frequency = &lt;1000000&gt;;
			};
		    };
		};
	};

	fragment@1 {
		target = &lt;&amp;gpio&gt;;
		__overlay__ {
			fc2_spi_pins: fc2-spi-pins {
				/* SPI - SCLK, MISO, MOSI */
				pins = "GPIO_43", "GPIO_44", "GPIO_45";
				function = "fc2_b";
			};
		};
	};
};</pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  This page was built using <a href="https://antora.org">Antora</a>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
